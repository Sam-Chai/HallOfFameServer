# <img src="logo.png" alt="Hall of Fame logo, AI-generated by Dall-E 2." align="right" style="width: 200px">Hall of Fame Server

[![Discord](https://img.shields.io/badge/Discord-@toverux-5865f2?logo=discord&logoColor=white&style=flat-square)](https://discord.gg/SsshDVq2Zj)
[![Paradox Mods](https://img.shields.io/badge/Paradox_Mods-Unreleased_yet-5abe41?style=flat-square)](https://mods.paradoxplaza.com/games/cities_skylines_2)

Server part of the [Hall of Fame](https://github.com/toverux/HallOfFame) mod for Cities: Skylines II.

This is a [Nest.js](https://nestjs.com/) project with an [Angular](https://angular.dev) w/SSR frontend and
[Prisma](https://www.prisma.io) as a MongoDB ORM.

Featuring a simple REST-like HTTP API for uploading photos from the mod and retrieving them.

## Features & Roadmap

This only covers what needs to be implemented server-side.<br>
Client side Roadmap is maintained in the client repository.

- For Beta:
  - Upload endpoint.
  - Image resize and storage on Azure.
  - Mongo Database with Prisma, storing creator name, creator ID, city name/pop, photo, date of post, IP address.
  - Rate Limiting for uploads.
  - IP and username banning.
  - Moderation admin web interface.
  - Get random photo endpoint.
  - Deployment with PM2.

- Planned next:
  - Add comment to uploads.
  - Localization for error messages.
  - Report abuse endpoint, abuse management admin interface.
  - Upvote endpoint
  - Get random photo endpoint with preferences (most liked, most recent, mixed, etc.).
  - Get photo endpoint returning photos not already seen.

- In the future, maybe:
  - Get photo from the same city endpoint.
  - Follow creator to see more of their uploads.
  - Photo labelling so you can choose your preferred style of pictures to see (ex. landscape, detailing, skyline, aerial, etc.).
  - Website for photo listing.
  - Personal space for creators to manage their collection.

## Development

### Installation

1. Install [Bun](https://bun.sh).
2. (Recommended) Install [Volta](https://volta.sh) for per-project Node.js version management,
   or use Node >= 22. Node is still needed to run the bundlers, while Bun is used for package
   management and the server runtime.
3. Run `bun i` to install dependencies.
4. You may `bun run build` to test that the project builds and everything is in order.
5. Install [MongoDB](https://www.mongodb.com/docs/manual/administration/install-community), and setup a replica set,
   here's an example but it varies according to your setup and preferences:
   1. Set this in your configuration file (`/etc/mongod.conf`):
      ```yml
      replication:
        replSetName: rs0
      ```
   2. Restart MongoDB (`sudo systemctl restart mongod`).
   3. Using `mongosh`, run `rs.initiate()` to create a default rs0 replica set.
   4. ...or follow [this guide](https://www.mongodb.com/docs/manual/tutorial/convert-standalone-to-replica-set/).

### Development Workflow

TBD

### Generating Database Schema

Database schema is generated from the Prisma schema file in `prisma/schema.prisma`.

You might have to reconfigure the default development connection string if it differs from the default in `.env`.
If it does differ, as `.env` is a defaults files that is versioned, do not change it, instead override locally in your
shell (unfortunately we can't make Prisma support `.env.local` easily).

- Update database schema from Prisma schema: `bun prisma db push`.<br>
  As the database is MongoDB which is schema-less, this essentially just creates the collections (and the database if it
  does not exist), and indexes.
- Update Prisma Client definitions after schema change: `bun prisma generate`.<br>
  Note that this is also done by `prisma db push`.

### Updating Dependencies & Toolchain

- To update Bun: `bun upgrade`, and update `package.json#packageManager`.
- To update Node: `volta install node@latest`, and update `package.json#engines.node`.
- To update npm dependencies: `bun check-updates`.

## Code Style

### TypeScript

TypeScript code is formatted and linted by [Biome](https://biomejs.dev).
Run `bun run check` to check for linting errors, format files and autofix simple issues.

You can also use Biome directly with `bun biome`.

The formatter and linter should run as a pre-commit hook if you have it installed,
which should be done automatically when running `bun i` (otherwise run `bun lefthook install`).

I'd suggest to use a Biome plugin for your editor to ease development.

If a rule seems out of place for this project, you can either disable/reconfigure
it in the `biome.json` file or disable it with an annotation comment, but these
should be justified and concerted.

### Commit messages

Commits must follow the [Conventional Commits](https://www.conventionalcommits.org/en/v1.0.0)
specification and more specifically the Angular one.

Scope can be one or more of the following:
- `server`: for non-specific changes in the server;
- `admin`: for changes in the backoffice admin interface;
- `api`: for changes in the server HTTP API;
- `imgproc`: for changes in image processing;
- `database`: for changes in the database schema or related systems;
- `i18n`: for changes in translations and translations system;
- `deps`: for dependencies updates;
- Propose new scopes if needed!
